name: Build and Deploy
on: [push]

jobs:
  build-deploy:
    name: Build with repo ${{ matrix.repo }} image tag ${{ matrix.tag }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tag: ['release', 'master', '19.08']
        include:
        - tag: 'latest'
          repo: release
        - tag: 'master'
          repo: master
        - tag: '19.08'
          repo: 1908

    steps:
    - uses: actions/checkout@v1

    - name: Build image
      env:
        REPO: ${{ matrix.repo }}
        TAG: ${{ matrix.tag }}
      run: |
        make build
        docker images
        docker run --rm "ligato/vpp-base:$TAG" dpkg-query -f '${Version}' -W vpp

    - name: Deploy
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
